<!DOCTYPE html>
<html>
	<head>
		<title>wpcom.js over iframe proxy Media Upload Test Page</title>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

		<style type="text/css">
			input[type=text] {
				width: 300px;
				height: 30px;
				line-height: 30px;
			}
			label {
				display: inline-block;
				width: 200px;
			}

			#image {
				width: 300px;
			}
		</style>
	</head>

	<body>
		<div>
			Select one or more files to upload media library .
		</div>
		<br />
		<div id="site">connecting to blog ...</div>
		<hr />
		<div>
			<label>site ID</label>
			<input type="text" id="site-node" value="altovalledotorg.wordpress.com"  />
			<br />

			<label>image ID</label>
			<input type="text" id="image-node-id"/>
			<br />

			<label>Title</label>
			<input type="text" id="image-node-title" />
			<br />

			<label>Caption</label>
			<input type="text" id="image-node-caption" />
			<br />

			<label>Description</label>
			<input type="text" id="image-node-description" />
			<br />

			<img src="#" id="image-node" />
			<br />

			<input type="file" id="file" disabled />
		</div>
		<hr />

		<script src="../dist/wpcom.js"></script>
		<script src="http://wzrd.in/standalone/wpcom-proxy-request@1.0.x"></script>

		<script>
			/* global WPCOM, wpcomProxyRequest */
			/* eslint-disable no-var, no-console, no-trailing-spaces, eol-last */
			/* eslint no-undef: "error" */
			var wpcom = WPCOM();

			// have this `wpcom` instance use the `wpcom-proxy-request`
			// function for API requests
			wpcom.request = wpcomProxyRequest;

			// upgrade to "access all users blogs" mode
			wpcom.request( {
				metaAPI: { accessAllUsersBlogs: true }
			}, function( err ) {
				if ( err ) {
					throw err;
				}
				console.log( 'proxy now running in "access all user\'s blogs" mode' );
			} );

			var siteNode = document.getElementById( 'site-node' );
			var imageNodeId = document.getElementById( 'image-node-id' );
			var titleNode = document.getElementById( 'image-node-title' );
			var captionNode = document.getElementById( 'image-node-caption' );
			var descriptionNode = document.getElementById( 'image-node-description' );
			var imageNode = document.getElementById( 'image-node' );

			var input = document.getElementById( 'file' );

			let mediaId = document.location && document.location.search ? document.location.search.replace( /\?id=/, '' ) : null;
			var siteId = siteNode.value;

			if ( mediaId ) {
				imageNodeId.value = mediaId;
			}

			wpcom
				.site( siteId )
				.media( mediaId )
				.get()
				.then( image => {
					titleNode.value = image.title;
					captionNode.value = image.caption;
					descriptionNode.value = image.description;
					input.removeAttribute( 'disabled' );
					imageNode.setAttribute( 'src', image.URL );
					console.log( 'image: %o', image );
				} )
				.catch( err => console.error( err ) );

			// select files on the "input" element
			input.onchange = function( e ) {
				mediaId = Number( imageNodeId.value );
				var req;

				if ( ! mediaId ) {
					var files = [];
					for ( var i = 0; i < e.target.files.length; i++ ) {
						files.push( e.target.files[ i ] );
					}

					req = wpcom
						.site( siteId )
						.media( mediaId )
						.addFiles( files, function( err, res ) {
							if ( err ) {
								throw err;
							}

							console.log( 'response', res );
						} );
				} else {
					var file = e.target.files[ 0 ];
					req = wpcom
						.site( siteId )
						.media( mediaId )
						.update( { apiVersion: '1.2' }, {
							title: titleNode.value,
							caption: captionNode.value,
							description: descriptionNode.value,
							media: file
						}, ( error, resp ) => {
							if ( error ) {
								return console.error( error );
							}

							console.log( 'resp: ', resp );
							imageNode.setAttribute( 'src', resp.URL );
						} );
				}

				req.upload.onprogress = onprogress;
			};

			function onprogress( e ) {
				if ( e.lengthComputable ) {
					var percentComplete = e.loaded / e.total * 100;
					console.log( 'progress event! %s%', percentComplete.toFixed( 2 ) );
				} else {
					// Unable to compute progress information since the total size is unknown
				}
			}
		</script>
	</body>
</html>
